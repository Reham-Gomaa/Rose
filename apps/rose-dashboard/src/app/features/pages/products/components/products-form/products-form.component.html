<div class="form-container">
  <div class="form-card">
    @if (isLoading()) {
      <!-- Skeleton for form loading -->
      <div class="p-fluid">
        <div class="flex flex-column gap-4">
          <!-- Title field skeleton -->
          <div class="flex flex-column gap-2">
            <p-skeleton width="120px" height="1.5rem"></p-skeleton>
            <p-skeleton width="100%" height="3rem"></p-skeleton>
          </div>
          
          <!-- Description field skeleton -->
          <div class="flex flex-column gap-2">
            <p-skeleton width="140px" height="1.5rem"></p-skeleton>
            <p-skeleton width="100%" height="3rem"></p-skeleton>
          </div>
          
          <!-- Price/Discount skeleton -->
          <div class="flex flex-column gap-2">
            <p-skeleton width="200px" height="1.5rem"></p-skeleton>
            <div class="grid">
              <div class="col-4"><p-skeleton width="100%" height="3rem"></p-skeleton></div>
              <div class="col-4"><p-skeleton width="100%" height="3rem"></p-skeleton></div>
              <div class="col-4"><p-skeleton width="100%" height="3rem"></p-skeleton></div>
            </div>
          </div>
          
          <!-- Submit button skeleton -->
          <p-skeleton width="100%" height="3rem"></p-skeleton>
        </div>
      </div>
    } @else {
      <!-- Form Header -->
      <div class="form-header mb-4">
        <h2>{{ getFormTitle() }}</h2>
      </div>

      <form [formGroup]="productForm" (ngSubmit)="handleFormSubmit()" class="p-fluid">
        <div class="flex flex-column gap-4">
          
          <!-- Title Field -->
          <lib-custom-input
            id="productTitle"
            [labelText]="getFieldLabel('title')"
            [placeholder]="getFieldPlaceholder('title')"
            [errorHandilgControl]="productForm.get('title')!"
            formControlName="title">
          </lib-custom-input>

          <!-- Description Field -->
          <div class="flex flex-column gap-2">
            <label class="font-medium text-sm text-gray-700">{{ getFieldLabel('description') }}</label>
            <textarea
              [placeholder]="getFieldPlaceholder('description')"
              formControlName="description"
              rows="4"
              class="w-full p-3 border-1 border-gray-300 border-round-md focus:border-primary focus:shadow-none"
              [class.border-red-500]="productForm.get('description')?.invalid && productForm.get('description')?.touched">
            </textarea>
            @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
              <small class="text-red-500 text-sm">Product description is required</small>
            }
          </div>

          <!-- Price, Discount, and Price After Discount -->
          <div class="flex flex-column gap-2">
            <div class="grid">
              <div class="col-12 md:col-4">
                <lib-custom-input
                  id="productPrice"
                  type="number"
                  [labelText]="getFieldLabel('price')"
                  [placeholder]="getFieldPlaceholder('price')"
                  [errorHandilgControl]="productForm.get('price')!"
                  formControlName="price">
                </lib-custom-input>
              </div>
              <div class="col-12 md:col-4">
                <lib-custom-input
                  id="productDiscount"
                  type="number"
                  [labelText]="getFieldLabel('discount')"
                  [placeholder]="getFieldPlaceholder('discount')"
                  [errorHandilgControl]="productForm.get('discount')!"
                  formControlName="discount">
                </lib-custom-input>
              </div>
              <div class="col-12 md:col-4">
                <div class="flex flex-column gap-2">
                  <label class="font-medium text-sm text-gray-700">Price after discount</label>
                  <div class="p-3 border-1 border-gray-300 border-round-md bg-gray-50">
                    <span class="text-gray-700">{{ priceAfterDiscount | currency }}</span>
                  </div>
                  <small class="text-gray-500 text-sm">Calculated automatically</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Quantity Field -->
          <lib-custom-input
            id="productQuantity"
            type="number"
            [labelText]="getFieldLabel('quantity')"
            [placeholder]="getFieldPlaceholder('quantity')"
            [errorHandilgControl]="productForm.get('quantity')!"
            formControlName="quantity">
          </lib-custom-input>

          <!-- Image Upload Section -->
          @if (!isEditMode) {
            <!-- ADD MODE: Show file uploads -->
            <div class="grid">
              <div class="col-12 md:col-6">
                <div class="flex flex-column gap-2">
                  <label class="font-medium text-sm text-gray-700">{{ getFieldLabel('imgCover') }}</label>
                  <input
                    type="file"
                    accept="image/*"
                    id="coverImage"
                    (change)="onCoverImageSelected($event)"
                    class="w-full"
                    #coverInput>
                  
                  <button 
                    type="button" 
                    (click)="coverInput.click()"
                    class="p-button p-button-outlined w-full mt-2">
                    <i class="pi pi-upload mr-2"></i>
                    Upload Cover Image
                  </button>
                  
                  @if (coverPreviewUrl) {
                    <div class="image-preview mt-2">
                      <p class="text-sm text-gray-600 mb-1">Cover Preview:</p>
                      <img [src]="coverPreviewUrl" alt="Cover preview" 
                           class="preview-image cursor-pointer" 
                           (click)="openImageModal(coverPreviewUrl!, 'Cover Image')"
                           style="max-width: 200px; max-height: 150px; border-radius: 8px;">
                    </div>
                  }
                  @if (productForm.get('imgCover')?.invalid && productForm.get('imgCover')?.touched) {
                    <small class="text-red-500 text-sm">Product cover is required</small>
                  }
                </div>
              </div>
              
              <div class="col-12 md:col-6">
                <div class="flex flex-column gap-2">
                  <label class="font-medium text-sm text-gray-700">{{ getFieldLabel('images') }}</label>
                  <input
                    type="file"
                    accept="image/*"
                    id="galleryImages"
                    multiple
                    (change)="onGalleryImagesSelected($event)"
                    class="w-full"
                    #galleryInput>
                  
                  <button 
                    type="button" 
                    (click)="galleryInput.click()"
                    class="p-button p-button-outlined w-full mt-2">
                    <i class="pi pi-upload mr-2"></i>
                    Upload Gallery Images
                  </button>
                  
                  @if (galleryPreviewUrls.length > 0) {
                    <div class="image-preview mt-2">
                      <p class="text-sm text-gray-600 mb-1">Gallery Previews ({{ galleryPreviewUrls.length }}):</p>
                      <div class="flex flex-wrap gap-2">
                        @for (url of galleryPreviewUrls; track $index) {
                          <img [src]="url" [alt]="'Gallery image ' + ($index + 1)" 
                               class="preview-image cursor-pointer" 
                               (click)="openImageModal(url, 'Gallery Image ' + ($index + 1))"
                               style="max-width: 80px; max-height: 80px; border-radius: 8px;">
                        }
                      </div>
                    </div>
                  }
                  @if (productForm.get('images')?.invalid && productForm.get('images')?.touched) {
                    <small class="text-red-500 text-sm">Product gallery images are required</small>
                  }
                </div>
              </div>
            </div>
          } @else {
            <!-- EDIT MODE: Show view image links -->
            <div class="grid">
              <div class="col-12 md:col-6">
                <div class="flex flex-column gap-2">
                  <label class="font-medium text-sm text-gray-700">Product cover</label>
                  @if (coverPreviewUrl) {
                    <button type="button" 
                            (click)="openImageModal(coverPreviewUrl, 'Product Cover')"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors duration-200 w-fit p-button p-button-text">
                      View product cover
                    </button>
                  } @else {
                    <span class="text-gray-500 text-sm">No cover image available</span>
                  }
                </div>
              </div>
              
              <div class="col-12 md:col-6">
                <div class="flex flex-column gap-2">
                  <label class="font-medium text-sm text-gray-700">Product gallery</label>
                  @if (galleryPreviewUrls.length > 0) {
                    <button type="button" 
                            (click)="openImageModal(galleryPreviewUrls[0], 'Product Gallery')"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors duration-200 w-fit p-button p-button-text">
                      View product gallery
                    </button>
                  } @else {
                    <span class="text-gray-500 text-sm">No gallery images available</span>
                  }
                </div>
              </div>
            </div>
          }

          <!-- Category and Occasion Dropdowns -->
          <div class="grid">
            <div class="col-12 md:col-6">
              <div class="flex flex-column gap-2">
                <label class="font-medium text-sm text-gray-700">{{ getFieldLabel('category') }}</label>
                <p-dropdown 
                  [options]="categories()" 
                  optionLabel="name" 
                  optionValue="_id"
                  formControlName="category"
                  placeholder="Select an option"
                  [class.border-red-500]="productForm.get('category')?.invalid && productForm.get('category')?.touched"
                  styleClass="w-full">
                </p-dropdown>
                @if (productForm.get('category')?.invalid && productForm.get('category')?.touched) {
                  <small class="text-red-500 text-sm">Please select a category for the product</small>
                }
              </div>
            </div>
            
            <div class="col-12 md:col-6">
              <div class="flex flex-column gap-2">
                <label class="font-medium text-sm text-gray-700">{{ getFieldLabel('occasion') }}</label>
                <p-dropdown 
                  [options]="occasions()" 
                  optionLabel="name" 
                  optionValue="_id"
                  formControlName="occasion"
                  placeholder="Select an option"
                  styleClass="w-full">
                </p-dropdown>
              </div>
            </div>
          </div>

          <!-- Divider -->
          <div class="divider"></div>

          <!-- Submit Button -->
          <lib-form-button
            type="submit"
            [text]="isEditMode ? 'Update Product' : 'Add Product'"
            [loadingText]="'Saving...'"
            [disabled]="productForm.invalid"
            [isLoading]="isSubmitting"
            [fullWidth]="true">
          </lib-form-button>
        </div>
      </form>
    }
  </div>
</div>

<!-- PrimeNG Dialog for Image Modal -->
<p-dialog 
  [header]="modalImageTitle" 
  [(visible)]="showImageModal" 
  [modal]="true" 
  [style]="{ width: '50rem' }" 
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [draggable]="false" 
  [resizable]="false"
  styleClass="image-modal">
  <div class="flex justify-content-center">
    <img 
      [src]="modalImageUrl" 
      [alt]="modalImageTitle" 
      class="w-full max-h-30rem object-contain" />
  </div>
</p-dialog>
